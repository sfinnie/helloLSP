
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>A First Server &#8212; HelloLSP  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Testing" href="testing.html" />
    <link rel="prev" title="Introduction" href="intro.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="a-first-server">
<h1>A First Server<a class="headerlink" href="#a-first-server" title="Permalink to this heading">¶</a></h1>
<p><a name="implementation-skeleton"></a></p>
<section id="implementation-skeleton">
<h2>Implementation Skeleton<a class="headerlink" href="#implementation-skeleton" title="Permalink to this heading">¶</a></h2>
<p>OK, enough of the talking - let’s code.  I’m assuming a Unix-like environment below, with a <code class="docutils literal notranslate"><span class="pre">bash</span></code> shell.  That should work for Linux, MacOS and Windows subsystem for Linux (WSL).</p>
<section id="pre-requisites">
<h3>Pre-Requisites<a class="headerlink" href="#pre-requisites" title="Permalink to this heading">¶</a></h3>
<p>We’re using vscode as the editor, so you need to <a class="reference external" href="https://code.visualstudio.com/download">install it first</a>.  You’ll also need to install <a class="reference external" href="https://git-scm.com/">git</a>,   <a class="reference external" href="https://nodejs.org/">Node.js</a> and <a class="reference external" href="https://www.python.org/downloads/">Python</a>.</p>
<p>Then create a new directory to hold the project:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="nb">cd</span><span class="w"> </span>/my/projects/dir
<span class="linenos">2</span>mkdir<span class="w"> </span>helloLSP<span class="w"> </span>
<span class="linenos">3</span><span class="nb">cd</span><span class="w"> </span>helloLSP
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can copy all the code from the git repository <a class="reference external" href="https://github.com/sfinnie/helloLSP">here</a> if you’d prefer not to follow these steps.</p>
</div>
<p>There’s a fair bit of boilerplate that needs to be in place before we can really get started on implementing support for <code class="docutils literal notranslate"><span class="pre">greet</span></code>.  It’s a bit fiddly and difficult to get right from first principles.  However, luckily, we don’t need to. I used <a class="reference external" href="https://github.com/openlawlibrary/pygls/tree/master/examples/json-vscode-extension">this example</a> as a template.  There are <a class="reference external" href="https://microsoft.github.io/language-server-protocol/implementors/servers/">many</a> <a class="reference external" href="https://github.com/openlawlibrary/pygls/tree/master/examples">examples</a> <a class="reference external" href="https://github.com/microsoft/vscode-python-tools-extension-template">available</a> and reading some others too is worthwhile to get a sense of what’s involved.</p>
<p>To build initially and check it’s working:</p>
<ol class="arabic">
<li><p>Set up the Server Python environment</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>python3<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>venv
<span class="linenos">2</span><span class="nb">source</span><span class="w"> </span>venv/bin/activate
<span class="linenos">3</span>python3<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-U<span class="w"> </span>pip
<span class="linenos">4</span>python3<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pygls
</pre></div>
</div>
</li>
<li><p>Set up the client nodejs environment</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>npm<span class="w"> </span>install
<span class="linenos">2</span><span class="nb">cd</span><span class="w"> </span>client
<span class="linenos">3</span>npm<span class="w"> </span>install
<span class="linenos">4</span><span class="nb">cd</span><span class="w"> </span>..
</pre></div>
</div>
</li>
<li><p>Start vscode in the project root dir</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>code<span class="w"> </span>.
</pre></div>
</div>
</li>
<li><p>Edit <code class="docutils literal notranslate"><span class="pre">vscode/settings.json</span></code> to ensure the python interpreter path is set correctly:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="p">{</span>
<span class="linenos">2</span><span class="w">    </span><span class="nt">&quot;python.interpreterPath&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;${workspaceFolder}/venv/bin/python3&quot;</span>
<span class="linenos">3</span><span class="p">}</span>
</pre></div>
</div>
<p>You’ll need to adjust this as required for your platform.  On Windows, this is likely to be <code class="docutils literal notranslate"><span class="pre">${workspaceFolder}/venv/Scripts/python</span></code>.</p>
</li>
<li><p>Run the extension client and server in a separate “development” instance of vscode by typing <code class="docutils literal notranslate"><span class="pre">ctrl-shift-D</span></code>, selecting <code class="docutils literal notranslate"><span class="pre">Server</span> <span class="pre">+</span> <span class="pre">Client</span></code> in the “Launch” dropdown at the top of the screen, and hitting <code class="docutils literal notranslate"><span class="pre">F5</span></code>.</p></li>
<li><p>In the development instance of vscode, open the <code class="docutils literal notranslate"><span class="pre">samples</span></code> sub-directory of this project.</p></li>
<li><p>Open the sample json file.  The editor should show an information message at the bottom of the main window that says “Text Document Did Open”.</p></li>
</ol>
<p>With that done, the basics are all in place.  Close the development instance for now and go back to the main project instance.  The code at this point is <a class="reference external" href="https://github.com/sfinnie/helloLSP/releases/tag/v0.1">tagged as v0.1</a> if you want to have a look.</p>
</section>
</section>
<section id="anatomy-of-the-plugin">
<h2>Anatomy of the Plugin<a class="headerlink" href="#anatomy-of-the-plugin" title="Permalink to this heading">¶</a></h2>
<p>Despite all the boilerplate, there are 3 primary files that implement the plugin:</p>
<ul class="simple">
<li><p><a class="reference download internal" download="" href="_downloads/340330e2bd4fb2b2c2fd38f79b5b5a80/extension.ts"><span class="xref download myst">client/src/extension.ts</span></a> implements the client</p></li>
<li><p><a class="reference download internal" download="" href="_downloads/bda231c91a6a6147addc1908f62796cd/server.py"><span class="xref download myst">server/server.py</span></a> implements the server.</p></li>
<li><p><a class="reference download internal" download="" href="_downloads/107ae6f6a70591a8435722bf4be2e286/package.json"><span class="xref download myst">package.json</span></a> describes the capabilities that the client and server provide.</p></li>
</ul>
</section>
<section id="tidying-up-the-skeleton">
<h2>Tidying up the skeleton<a class="headerlink" href="#tidying-up-the-skeleton" title="Permalink to this heading">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you’re eager to get onto actually implementing language support, then <a class="reference internal" href="#language-implementation">skip ahead</a>.  This section cleans up the skeleton and gets ready for that.  Understanding how things fit together can be instructive, but if it’s not your bag, move along.</p>
</div>
<p>With the skeleton in place, we can start making the changes needed to support our <code class="docutils literal notranslate"><span class="pre">greet</span></code> language.   There are a few housekeeping tasks to complete:</p>
<ol class="arabic simple">
<li><p>Change the plugin so it’s activated on files with a <code class="docutils literal notranslate"><span class="pre">.greet</span></code> extension (the skeleton is activated for <code class="docutils literal notranslate"><span class="pre">json</span></code> files)</p></li>
<li><p>Get rid of the extraneous commands supported by the skeleton that we don’t need.</p></li>
<li><p>Rename the relevant classes, methods and names from <code class="docutils literal notranslate"><span class="pre">json</span></code> to <code class="docutils literal notranslate"><span class="pre">greet</span></code></p></li>
</ol>
<section id="tiny-baby-steps-setting-the-language">
<h3>Tiny baby steps - setting the language<a class="headerlink" href="#tiny-baby-steps-setting-the-language" title="Permalink to this heading">¶</a></h3>
<p>Let’s start with the filename extension.  There’s actually 2 parts to this, because vscode separates language <em>identity</em> from the filename <em>extension</em>.  That allows a single language to support multiple extensions.  For example: the Java tooling supports both <code class="docutils literal notranslate"><span class="pre">.jav</span></code> and <code class="docutils literal notranslate"><span class="pre">.java</span></code> extensions.</p>
<p>The language and extension(s) are configured in the <code class="docutils literal notranslate"><span class="pre">package.json</span></code> file.  The relevant section in the skeleton reads as follows:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="nt">&quot;activationEvents&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="linenos">2</span><span class="w">    </span><span class="s2">&quot;onLanguage:json&quot;</span>
<span class="linenos">3</span><span class="w">  </span><span class="p">],</span>
</pre></div>
</div>
<p>We need to make a few changes.  For a start, the skeleton assumes vscode already knows about <code class="docutils literal notranslate"><span class="pre">json</span></code> as a language.  It won’t know anything about <code class="docutils literal notranslate"><span class="pre">greet</span></code> though.  So we need to define the language identity, define the file extensions, and let vscode know when to activate our plugin.  Here’s what that looks like<a class="footnote-reference brackets" href="#id4" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nt">&quot;contributes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 2</span><span class="w">    </span><span class="nt">&quot;languages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="linenos"> 3</span><span class="w">      </span><span class="p">{</span>
<span class="linenos"> 4</span><span class="w">        </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;greet&quot;</span><span class="p">,</span>
<span class="linenos"> 5</span><span class="w">        </span><span class="nt">&quot;aliases&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="linenos"> 6</span><span class="w">          </span><span class="s2">&quot;Greet&quot;</span><span class="p">,</span>
<span class="linenos"> 7</span><span class="w">          </span><span class="s2">&quot;greet&quot;</span>
<span class="linenos"> 8</span><span class="w">        </span><span class="p">],</span>
<span class="linenos"> 9</span><span class="w">        </span><span class="nt">&quot;extensions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="linenos">10</span><span class="w">          </span><span class="s2">&quot;.greet&quot;</span>
<span class="linenos">11</span><span class="w">        </span><span class="p">]</span>
<span class="linenos">12</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">13</span><span class="w">    </span><span class="p">]</span>
<span class="linenos">14</span><span class="p">},</span>
<span class="linenos">15</span><span class="nt">&quot;activationEvents&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="linenos">16</span><span class="w">    </span><span class="s2">&quot;onLanguage:greet&quot;</span>
<span class="linenos">17</span><span class="w">  </span><span class="p">],</span>
</pre></div>
</div>
<p>It’s also referenced in <code class="docutils literal notranslate"><span class="pre">client/src/extension.ts</span></code>:</p>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kd">function</span><span class="w"> </span><span class="nx">getClientOptions</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nx">LanguageClientOptions</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 2</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 3</span><span class="w">        </span><span class="c1">// Register the server for plain text documents</span>
<span class="linenos"> 4</span><span class="w">        </span><span class="nx">documentSelector</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="linenos"> 5</span><span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nx">scheme</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;file&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">language</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;json&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="linenos"> 6</span><span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nx">scheme</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;untitled&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">language</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;json&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="linenos"> 7</span><span class="w">        </span><span class="p">],</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="c1">//...</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">10</span><span class="p">}</span>
</pre></div>
</div>
<p>We need to change that to:</p>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kd">function</span><span class="w"> </span><span class="nx">getClientOptions</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nx">LanguageClientOptions</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 2</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 3</span><span class="w">        </span><span class="c1">// Register the server for &#39;greet&#39; documents</span>
<span class="linenos"> 4</span><span class="w">        </span><span class="nx">documentSelector</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="hll"><span class="linenos"> 5</span><span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nx">scheme</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;file&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">language</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;greet&quot;</span><span class="w"> </span><span class="p">},</span>
</span><span class="hll"><span class="linenos"> 6</span><span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nx">scheme</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;untitled&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">language</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;greet&quot;</span><span class="w"> </span><span class="p">},</span>
</span><span class="linenos"> 7</span><span class="w">        </span><span class="p">],</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="c1">//...</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">10</span><span class="p">}</span>
</pre></div>
</div>
<p>With those changed, we can launch the plugin in a development window again (<code class="docutils literal notranslate"><span class="pre">ctrl-shift-D</span></code>, select “Server + Client”, hit <code class="docutils literal notranslate"><span class="pre">F5</span></code>).  Open <code class="docutils literal notranslate"><span class="pre">samples/valid.greet</span></code> in the editor and, again, you should see the <code class="docutils literal notranslate"><span class="pre">Text</span> <span class="pre">Document</span> <span class="pre">Did</span> <span class="pre">Open</span></code> message. Close the development instance.  Change 1 complete.</p>
</section>
<section id="cleaning-up">
<h3>Cleaning up<a class="headerlink" href="#cleaning-up" title="Permalink to this heading">¶</a></h3>
<p>The skeleton plugin implements multiple commands for illustration.  We don’t need them here, so they can be removed.  If you run the plugin in a development instance and type <code class="docutils literal notranslate"><span class="pre">ctrl-shift-p</span></code> then enter “countdown” in the dialogue box, you should see several options like “Count down 10 seconds [Blocking]”.  That needs changes in 2 places:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">package.json</span></code>, which declares the commands the plugin supports</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">server.py</span></code> which implements them.</p></li>
</ul>
<p>Here’s an excerpt from each.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="c1">//package.json</span>
<span class="linenos">2</span><span class="w">    </span><span class="nt">&quot;commands&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="linenos">3</span><span class="w">      </span><span class="p">{</span>
<span class="hll"><span class="linenos">4</span><span class="w">        </span><span class="nt">&quot;command&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;countDownBlocking&quot;</span><span class="p">,</span>
</span><span class="linenos">5</span><span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Count down 10 seconds [Blocking]&quot;</span>
<span class="linenos">6</span><span class="w">      </span><span class="p">},</span>
<span class="linenos">7</span><span class="w">      </span><span class="c1">// several more</span>
<span class="linenos">8</span><span class="w">    </span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1"># server.py</span>
<span class="linenos"> 2</span><span class="k">class</span> <span class="nc">JsonLanguageServer</span><span class="p">(</span><span class="n">LanguageServer</span><span class="p">):</span>
<span class="hll"><span class="linenos"> 3</span>    <span class="n">CMD_COUNT_DOWN_BLOCKING</span> <span class="o">=</span> <span class="s1">&#39;countDownBlocking&#39;</span>
</span><span class="linenos"> 4</span>    <span class="c1"># several more</span>
<span class="linenos"> 5</span> 
<span class="hll"><span class="linenos"> 6</span><span class="nd">@json_server</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">JsonLanguageServer</span><span class="o">.</span><span class="n">CMD_COUNT_DOWN_BLOCKING</span><span class="p">)</span>
</span><span class="linenos"> 7</span><span class="k">def</span> <span class="nf">count_down_10_seconds_blocking</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Starts counting down and showing message synchronously.</span>
<span class="linenos"> 9</span><span class="sd">    It will `block` the main thread, which can be tested by trying to show</span>
<span class="linenos">10</span><span class="sd">    completion items.</span>
<span class="linenos">11</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos">12</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">COUNT_DOWN_START_IN_SECONDS</span><span class="p">):</span>
<span class="linenos">13</span>        <span class="n">ls</span><span class="o">.</span><span class="n">show_message</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Counting down... </span><span class="si">{</span><span class="n">COUNT_DOWN_START_IN_SECONDS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="linenos">14</span>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">COUNT_DOWN_SLEEP_IN_SECONDS</span><span class="p">)</span>
</pre></div>
</div>
<p>The link between the two is the <code class="docutils literal notranslate"><span class="pre">countdownBlocking</span></code> literal.  Removing the unnecessary commands requires removing:</p>
<ol class="arabic simple">
<li><p>the “commands” entry in <code class="docutils literal notranslate"><span class="pre">package.json</span></code></p></li>
<li><p>The corresponding constant definition in the <code class="docutils literal notranslate"><span class="pre">JsonLanguageServer</span></code> class</p></li>
<li><p>The python function that implements the class</p></li>
</ol>
<p>We’ll remove the configuration and code for the following commands:</p>
<ul class="simple">
<li><p>countDownBlocking</p></li>
<li><p>CountDownNonBlocking</p></li>
<li><p>showConfigurationAsync</p></li>
<li><p>showConfigurationCallback</p></li>
<li><p>showConfigurationThread</p></li>
</ul>
<p>Launching the development instance, typing <code class="docutils literal notranslate"><span class="pre">ctrl-shift-p</span></code> and entering “countdown” now doesn’t show up our commands.  Task complete.</p>
</section>
</section>
<section id="naming-enough-already-json">
<h2>Naming: enough, already, Json<a class="headerlink" href="#naming-enough-already-json" title="Permalink to this heading">¶</a></h2>
<p>The skeleton is based on suport for <code class="docutils literal notranslate"><span class="pre">json</span></code> files, and that’s used throughout <code class="docutils literal notranslate"><span class="pre">client/src/extension.ts</span></code>, <code class="docutils literal notranslate"><span class="pre">server/server.py</span></code> and <code class="docutils literal notranslate"><span class="pre">package.json</span></code>.</p>
<section id="package-json">
<h3>Package.json<a class="headerlink" href="#package-json" title="Permalink to this heading">¶</a></h3>
<p>Let’s start with <code class="docutils literal notranslate"><span class="pre">package.json</span></code>.  The first chunk of relevance sits right at the top of the file:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="p">{</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;json-extension&quot;</span><span class="p">,</span>
<span class="linenos"> 3</span><span class="w">  </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Simple json extension example&quot;</span><span class="p">,</span>
<span class="linenos"> 4</span><span class="w">  </span><span class="nt">&quot;author&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Open Law Library&quot;</span><span class="p">,</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="nt">&quot;repository&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://github.com/openlawlibrary/pygls&quot;</span><span class="p">,</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="nt">&quot;license&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Apache-2.0&quot;</span><span class="p">,</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0.11.3&quot;</span><span class="p">,</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="nt">&quot;publisher&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;openlawlibrary&quot;</span><span class="p">,</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="c1">//...</span>
<span class="linenos">10</span><span class="p">}</span>
</pre></div>
</div>
<p>We can change that as follows:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="p">{</span>
<span class="hll"><span class="linenos"> 2</span><span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;greet&quot;</span><span class="p">,</span>
</span><span class="hll"><span class="linenos"> 3</span><span class="w">  </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Support for the greet salutation example language&quot;</span><span class="p">,</span>
</span><span class="hll"><span class="linenos"> 4</span><span class="w">  </span><span class="nt">&quot;author&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sfinnie&quot;</span><span class="p">,</span>
</span><span class="hll"><span class="linenos"> 5</span><span class="w">  </span><span class="nt">&quot;repository&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://github.com/sfinnie/helloLSP&quot;</span><span class="p">,</span>
</span><span class="linenos"> 6</span><span class="w">  </span><span class="nt">&quot;license&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Apache-2.0&quot;</span><span class="p">,</span>
<span class="hll"><span class="linenos"> 7</span><span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0.0.1&quot;</span><span class="p">,</span>
</span><span class="hll"><span class="linenos"> 8</span><span class="w">  </span><span class="nt">&quot;publisher&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sfinnie&quot;</span><span class="p">,</span>
</span><span class="linenos"> 9</span><span class="w">  </span><span class="c1">//...</span>
<span class="linenos">10</span><span class="p">}</span>
</pre></div>
</div>
<p>The next bit is the configuration section.  It currently reads:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">    </span><span class="nt">&quot;configuration&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 2</span><span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="p">,</span>
<span class="linenos"> 3</span><span class="w">      </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Json Server Configuration&quot;</span><span class="p">,</span>
<span class="linenos"> 4</span><span class="w">      </span><span class="nt">&quot;properties&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 5</span><span class="w">        </span><span class="nt">&quot;jsonServer.exampleConfiguration&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 6</span><span class="w">          </span><span class="nt">&quot;scope&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;resource&quot;</span><span class="p">,</span>
<span class="linenos"> 7</span><span class="w">          </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
<span class="linenos"> 8</span><span class="w">          </span><span class="nt">&quot;default&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;You can override this message.&quot;</span>
<span class="linenos"> 9</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">10</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">11</span><span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
<p>It’s a bit academic, because we don’t have any configuration at the moment. It’s helpful to see how it fits together though, so let’s leave it in but update it:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="w">    </span><span class="nt">&quot;configuration&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 2</span><span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="p">,</span>
<span class="hll"><span class="linenos"> 3</span><span class="w">      </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Greet Server Configuration&quot;</span><span class="p">,</span>
</span><span class="linenos"> 4</span><span class="w">      </span><span class="nt">&quot;properties&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 5</span><span class="w">        </span><span class="nt">&quot;greetServer.exampleConfiguration&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 6</span><span class="w">          </span><span class="nt">&quot;scope&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;resource&quot;</span><span class="p">,</span>
<span class="linenos"> 7</span><span class="w">          </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
<span class="hll"><span class="linenos"> 8</span><span class="w">          </span><span class="nt">&quot;default&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Greet says you can override this message.&quot;</span>
</span><span class="linenos"> 9</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">10</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">11</span><span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
<p>That’s <code class="docutils literal notranslate"><span class="pre">package.json</span></code> done.  Let’s do the client next.</p>
</section>
<section id="extension-ts">
<h3>extension.ts<a class="headerlink" href="#extension-ts" title="Permalink to this heading">¶</a></h3>
<p>The only relevant section in the client is in the <code class="docutils literal notranslate"><span class="pre">getClientOptions()</span></code> function that we update earlier.  Here’s how it looks currently:</p>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="kd">function</span><span class="w"> </span><span class="nx">getClientOptions</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nx">LanguageClientOptions</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">3</span><span class="w">        </span><span class="c1">// Register the server for &#39;greet&#39; documents</span>
<span class="linenos">4</span><span class="w">        </span><span class="nx">documentSelector</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="linenos">5</span><span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nx">scheme</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;file&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">language</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;greet&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="linenos">6</span><span class="w">            </span><span class="p">{</span><span class="w"> </span><span class="nx">scheme</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;untitled&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">language</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;greet&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="linenos">7</span><span class="w">        </span><span class="p">],</span>
<span class="linenos">8</span><span class="w">        </span><span class="nx">outputChannelName</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;[pygls] JsonLanguageServer&quot;</span><span class="p">,</span>
</pre></div>
</div>
<p>It’s the last line we want to change, as follows:</p>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="linenos">8</span><span class="w">        </span><span class="nx">outputChannelName</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;[pygls] GreetLanguageServer&quot;</span><span class="p">,</span>
</pre></div>
</div>
<p>I’ve left <code class="docutils literal notranslate"><span class="pre">[pygls]</span></code> in there.  It’s completely optional, but it might be useful to know that’s what the server is based on.  If nothing else, it’s a nice little acknowledgement for the good folks who put <code class="docutils literal notranslate"><span class="pre">pygls</span></code> together and shared it with the world.</p>
<p>That’s it for the client - onto the server.</p>
</section>
<section id="server-py">
<h3>server.py<a class="headerlink" href="#server-py" title="Permalink to this heading">¶</a></h3>
<p>The change in the server is the main language server class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">class</span> <span class="nc">JsonLanguageServer</span><span class="p">(</span><span class="n">LanguageServer</span><span class="p">):</span>
<span class="linenos">2</span>    <span class="n">CMD_PROGRESS</span> <span class="o">=</span> <span class="s1">&#39;progress&#39;</span>
<span class="linenos">3</span>    <span class="c1">#...</span>
<span class="linenos">4</span>
<span class="linenos">5</span><span class="n">json_server</span> <span class="o">=</span> <span class="n">JsonLanguageServer</span><span class="p">(</span><span class="s1">&#39;pygls-json-example&#39;</span><span class="p">,</span> <span class="s1">&#39;v0.1&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Unsurprisingly, that becomes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="linenos">1</span><span class="k">class</span> <span class="nc">GreetLanguageServer</span><span class="p">(</span><span class="n">LanguageServer</span><span class="p">):</span>
</span><span class="linenos">2</span>    <span class="n">CMD_PROGRESS</span> <span class="o">=</span> <span class="s1">&#39;progress&#39;</span>
<span class="linenos">3</span>    <span class="c1">#...</span>
<span class="linenos">4</span>
<span class="hll"><span class="linenos">5</span><span class="n">greet_server</span> <span class="o">=</span> <span class="n">GreetLanguageServer</span><span class="p">(</span><span class="s1">&#39;pygls-greet-example&#39;</span><span class="p">,</span> <span class="s1">&#39;v0.1&#39;</span><span class="p">)</span>
</span></pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">greet_server</span></code> is referenced in several places in the file, so they all need updated.  Same with <code class="docutils literal notranslate"><span class="pre">GreetLanguageServer</span></code>.</p>
<p>There’s a couple of functions for validating the contents of a file (<code class="docutils literal notranslate"><span class="pre">_validate()</span></code>, <code class="docutils literal notranslate"><span class="pre">_validate_json()</span></code>).  We’re going to update them later, so can leave the <code class="docutils literal notranslate"><span class="pre">json</span></code> references for now.</p>
<p>That’s the renaming complete.  Time, at last, to actually start implementing our support for greet.</p>
</section>
</section>
<section id="implementing-greet-language-support">
<span id="language-implementation"></span><h2>Implementing Greet Language Support<a class="headerlink" href="#implementing-greet-language-support" title="Permalink to this heading">¶</a></h2>
<p>Hurrah!  Finally time to implement the language support.  But what does that actually mean?  The Language Server Protocol defines several <a class="reference external" href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#languageFeatures">language features</a>, for example:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_declaration">Goto Declaration</a></p></li>
<li><p><a class="reference external" href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_references">Find References</a></p></li>
<li><p><a class="reference external" href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_completion">Completion Items</a></p></li>
</ul>
<p>We’ll start with checking that a <code class="docutils literal notranslate"><span class="pre">greet</span></code> file is consistent with the <a class="reference internal" href="intro.html#greet-grammar"><span class="std std-ref">greet grammar</span></a>.  We know from <a class="reference internal" href="intro.html#protocol-overview"><span class="std std-ref">earlier</span></a> that notifications can be sent from the client to the server and vice-versa.  One of those notifications is <code class="docutils literal notranslate"><span class="pre">textDocument/didOpen</span></code> which is sent when a document, of the type supported by the plugin, is opened. We saw that in the development instance: it displayed the message <code class="docutils literal notranslate"><span class="pre">Text</span> <span class="pre">Document</span> <span class="pre">Did</span> <span class="pre">Open</span></code> when we opened a file with the <code class="docutils literal notranslate"><span class="pre">.greet</span></code> extension.  Here’s the source of that in <code class="docutils literal notranslate"><span class="pre">server.py</span></code>:</p>
<div class="highlight-python notranslate" id="did-open"><div class="highlight"><pre><span></span><span class="hll"><span class="linenos">1</span><span class="nd">@greet_server</span><span class="o">.</span><span class="n">feature</span><span class="p">(</span><span class="n">TEXT_DOCUMENT_DID_OPEN</span><span class="p">)</span>
</span><span class="linenos">2</span><span class="k">async</span> <span class="k">def</span> <span class="nf">did_open</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">DidOpenTextDocumentParams</span><span class="p">):</span>
<span class="linenos">3</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Text document did open notification.&quot;&quot;&quot;</span>
<span class="linenos">4</span>    <span class="n">ls</span><span class="o">.</span><span class="n">show_message</span><span class="p">(</span><span class="s1">&#39;Text Document Did Open&#39;</span><span class="p">)</span>
<span class="hll"><span class="linenos">5</span>    <span class="n">_validate</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span></pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">&#64;greet_server.feature</span></code> line is where <code class="docutils literal notranslate"><span class="pre">pygls</span></code> does its magic.  Behind that simple line, <code class="docutils literal notranslate"><span class="pre">pygls</span></code> manages receiving the notification in <code class="docutils literal notranslate"><span class="pre">json-rpc</span></code> format, parsing out the parameters into a <code class="docutils literal notranslate"><span class="pre">DidOpenTextDocumentParams</span></code> object, and calling the <code class="docutils literal notranslate"><span class="pre">did_open</span></code> function.  Aside from showing the message we saw on screen earlier<a class="footnote-reference brackets" href="#id5" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a>, the function calls <code class="docutils literal notranslate"><span class="pre">_validate()</span></code> to check the file contents <a class="footnote-reference brackets" href="#id6" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a>.</p>
<p>The skeleton <code class="docutils literal notranslate"><span class="pre">_validate()</span></code> function checks whether the file is valid <code class="docutils literal notranslate"><span class="pre">json</span></code> so we need to change that.  The compiler world tends to talk about <em>parsing</em> rather than <em>validating</em>.  It’s a bit pedantic, but I’m going to stick to that here.  So the functions we’ll look at are named <code class="docutils literal notranslate"><span class="pre">_parse()</span></code> not <code class="docutils literal notranslate"><span class="pre">_validate()</span></code>.  The skeleton functions cover the following:</p>
<ol class="arabic simple">
<li><p>Extracting the source file contents from the parameters</p></li>
<li><p>Checking the contents</p></li>
</ol>
<p>It’s worth noting at this point that the <code class="docutils literal notranslate"><span class="pre">DidOpenTextDocumentParams</span></code> object contains the <em>actual content</em> of the file being edited, not just a <code class="docutils literal notranslate"><span class="pre">uri</span></code> reference for it.  This is a deliberate design decision in the protocol.  From the <a class="reference external" href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_didOpen">spec</a>:</p>
<blockquote>
<div><p>The document’s content is now managed by the client and the server must not try to read the document’s content using the document’s Uri.</p>
</div></blockquote>
<p>Back to the functions.  The first one doesn’t change (other than the name and log message):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">def</span> <span class="nf">_parse</span><span class="p">(</span><span class="n">ls</span><span class="p">:</span> <span class="n">GreetLanguageServer</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">DidOpenTextDocumentParams</span><span class="p">):</span>
<span class="linenos">2</span>    <span class="n">ls</span><span class="o">.</span><span class="n">show_message_log</span><span class="p">(</span><span class="s1">&#39;Validating greeting...&#39;</span><span class="p">)</span>
<span class="linenos">3</span>
<span class="linenos">4</span>    <span class="n">text_doc</span> <span class="o">=</span> <span class="n">ls</span><span class="o">.</span><span class="n">workspace</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">text_document</span><span class="o">.</span><span class="n">uri</span><span class="p">)</span>
<span class="linenos">5</span>
<span class="linenos">6</span>    <span class="n">source</span> <span class="o">=</span> <span class="n">text_doc</span><span class="o">.</span><span class="n">source</span>
<span class="linenos">7</span>    <span class="n">diagnostics</span> <span class="o">=</span> <span class="n">_parse_greet</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="k">if</span> <span class="n">source</span> <span class="k">else</span> <span class="p">[]</span>
<span class="linenos">8</span>
<span class="linenos">9</span>    <span class="n">ls</span><span class="o">.</span><span class="n">publish_diagnostics</span><span class="p">(</span><span class="n">text_doc</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="n">diagnostics</span><span class="p">)</span>
</pre></div>
</div>
<p>Note the error handling if there’s no source content.  <code class="docutils literal notranslate"><span class="pre">ls.publish_diagnostics()</span></code> passes any errors found back to the client for display in the editor.  The meat is in the <code class="docutils literal notranslate"><span class="pre">_parse_greet()</span></code> function.  How do we parse the file?  The grammar tells us the rules for a greeting, but how do we implement it?  The skeleton takes advantage of Python’s <code class="docutils literal notranslate"><span class="pre">json.loads()</span></code> function to do the parsing.  Here’s the skeleton implementation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">def</span> <span class="nf">_parse_greet</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
<span class="linenos"> 2</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Validates json file.&quot;&quot;&quot;</span>
<span class="linenos"> 3</span>    <span class="n">diagnostics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 6</span>        <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="linenos"> 7</span>    <span class="k">except</span> <span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
<span class="linenos"> 8</span>        <span class="n">msg</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">msg</span>
<span class="linenos"> 9</span>        <span class="n">col</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">colno</span>
<span class="linenos">10</span>        <span class="n">line</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">lineno</span>
<span class="linenos">11</span>
<span class="linenos">12</span>        <span class="n">d</span> <span class="o">=</span> <span class="n">Diagnostic</span><span class="p">(</span>
<span class="linenos">13</span>            <span class="nb">range</span><span class="o">=</span><span class="n">Range</span><span class="p">(</span>
<span class="linenos">14</span>                <span class="n">start</span><span class="o">=</span><span class="n">Position</span><span class="p">(</span><span class="n">line</span><span class="o">=</span><span class="n">line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">character</span><span class="o">=</span><span class="n">col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
<span class="linenos">15</span>                <span class="n">end</span><span class="o">=</span><span class="n">Position</span><span class="p">(</span><span class="n">line</span><span class="o">=</span><span class="n">line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">character</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>
<span class="linenos">16</span>            <span class="p">),</span>
<span class="linenos">17</span>            <span class="n">message</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span>
<span class="linenos">18</span>            <span class="n">source</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">greet_server</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
<span class="linenos">19</span>        <span class="p">)</span>
<span class="linenos">20</span>
<span class="linenos">21</span>        <span class="n">diagnostics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="linenos">22</span>
<span class="linenos">23</span>    <span class="k">return</span> <span class="n">diagnostics</span>
</pre></div>
</div>
<p>The majority of the code deals with creating the <code class="docutils literal notranslate"><span class="pre">Diagnostic</span></code> - the data structure that informs the editor where the error lies, and what the problem is.</p>
<p>Not unreasonably, Python’s standard library doesn’t have a built-in function for reading <code class="docutils literal notranslate"><span class="pre">.greet</span></code> files.  There’s lots of well-established <a class="reference external" href="https://en.wikipedia.org/wiki/Parsing">theory</a> on parsing, several techniques, and lots of libraries to support it.  We’ll explore those later.  But for now, that’s a bit overkill for our needs here.  Our approach is broadly:</p>
<ol class="arabic simple">
<li><p>Read in the file, breaking it up into lines</p></li>
<li><p>For each line, check if it contains a valid greeting:</p>
<ol class="arabic simple">
<li><p>Does it start with either “Hello” or “Goodbye”?</p></li>
<li><p>If so, is it followed by a name that satisfies the <code class="docutils literal notranslate"><span class="pre">[a-zA-Z]+</span></code> pattern?</p></li>
</ol>
</li>
</ol>
<p>Here’s the implementation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">def</span> <span class="nf">_parse_greet</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos"> 2</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Parses a greeting file.  </span>
<span class="linenos"> 3</span><span class="sd">        Generates diagnostic messages for any problems found</span>
<span class="linenos"> 4</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 5</span>    <span class="n">diagnostics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 6</span>
<span class="hll"><span class="linenos"> 7</span>    <span class="n">grammar</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(Hello|Goodbye)\s+([a-zA-Z]+)\s*$&#39;</span><span class="p">)</span>
</span><span class="linenos"> 8</span>
<span class="linenos"> 9</span>    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()]</span>
<span class="linenos">10</span>    <span class="k">for</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">line_contents</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
<span class="linenos">11</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_contents</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">12</span>            <span class="c1"># Don&#39;t treat blank lines as an error</span>
<span class="linenos">13</span>            <span class="k">continue</span>
<span class="linenos">14</span>        
<span class="linenos">15</span>        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="n">line_contents</span><span class="p">)</span>
<span class="linenos">16</span>        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">17</span>            <span class="n">d</span> <span class="o">=</span> <span class="n">Diagnostic</span><span class="p">(</span>
<span class="linenos">18</span>                    <span class="nb">range</span><span class="o">=</span><span class="n">Range</span><span class="p">(</span>
<span class="linenos">19</span>                        <span class="n">start</span><span class="o">=</span><span class="n">Position</span><span class="p">(</span><span class="n">line</span><span class="o">=</span><span class="n">line_num</span><span class="p">,</span> <span class="n">character</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
<span class="linenos">20</span>                        <span class="n">end</span><span class="o">=</span><span class="n">Position</span><span class="p">(</span><span class="n">line</span><span class="o">=</span><span class="n">line_num</span><span class="p">,</span> <span class="n">character</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">line_contents</span><span class="p">))</span>
<span class="linenos">21</span>                    <span class="p">),</span>
<span class="linenos">22</span>                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Greeting must be either &#39;Hello &lt;name&gt;&#39; or &#39;Goodbye &lt;name&gt;&#39;&quot;</span><span class="p">,</span>
<span class="linenos">23</span>                    <span class="n">source</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">greet_server</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
<span class="linenos">24</span>                <span class="p">)</span>
<span class="linenos">25</span>            <span class="n">diagnostics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="linenos">26</span>
<span class="linenos">27</span> 
<span class="linenos">28</span>    <span class="k">return</span> <span class="n">diagnostics</span>
</pre></div>
</div>
<p>The first thing to note is the grammar:</p>
<div class="highlight-python notranslate" id="language-regex"><div class="highlight"><pre><span></span><span class="linenos">7</span><span class="n">grammar</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(Hello|Goodbye)\s+([a-zA-Z]+)\s*$&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>It’s a <a class="reference external" href="https://docs.python.org/3/howto/regex.html">regular expression</a> (aka regex) and shows off the pros and cons of using them.  On the ‘pro’ side, it’s a very succinct way of expressing the grammar.  On the ‘con’ side, it’s a very succinct way of expressing the grammar.  This is about the limit of regex complexity I’m personally comfortable with: it’s still readable with some concentration.  Much more than this, though, and I’d want to take a different approach.  For sake of clarity, let’s break it down.</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">^</span></code> means the grammar must match the start of the line: there can’t be any characters (including white space) before the first pattern</p></li>
<li><p>The first pattern matches the salutation: <code class="docutils literal notranslate"><span class="pre">(Hello|Goodbye)</span></code> means match the string ‘Hello’ or the string ‘Goodbye’.  The brackets mean the match will capture which string matched: we’re not using that here but will later.</p></li>
<li><p>The second pattern - <code class="docutils literal notranslate"><span class="pre">\s+</span></code> - means match one or more white space characters after the salutation and before what follows.  <code class="docutils literal notranslate"><span class="pre">\s</span></code> means match a single whitespace character (space, tab); <code class="docutils literal notranslate"><span class="pre">+</span></code> means match one or more.</p></li>
<li><p>The third pattern matches the name: <code class="docutils literal notranslate"><span class="pre">([a-zA-Z]+)</span></code>.  This is exactly the same as the formal grammar defined <a class="reference internal" href="intro.html#greet-grammar"><span class="std std-ref">previously</span></a>.  Again, the surrounding brackets mean the value should be captured if match is successful</p></li>
<li><p>The final pattern - <code class="docutils literal notranslate"><span class="pre">\s*$</span></code> - means match zero or more whitespace characters before the end of the line.  <code class="docutils literal notranslate"><span class="pre">\s</span></code> means match a single whitespace character as before; <code class="docutils literal notranslate"><span class="pre">*</span></code> means match zero or more; and <code class="docutils literal notranslate"><span class="pre">$</span></code> means match the end of the string.</p></li>
</ul>
<p>We iterate through each line in the file in turn, checking if it matches the grammar.  If it doesn’t, we create a <code class="docutils literal notranslate"><span class="pre">Diagnostic</span></code> instance that specifies the location of the problem and the error message to show.  In this first incarnation, we’re not breaking down where the error lies.  That’s viable with a grammar as simple as <code class="docutils literal notranslate"><span class="pre">greet</span></code> in its current form.  Anything more complex and we’d want to be a bit more specific with error messages, but it’s plenty good for now.  Spin up a development instance (<code class="docutils literal notranslate"><span class="pre">ctrl-shift-D</span></code> and <code class="docutils literal notranslate"><span class="pre">f5</span></code>), open the sample .greet file, and have a play.  The editor should show a red squiggly for any lines that don’t match the grammar, and show the diagnostic message if you hover over an error:</p>
<p><img alt="Sample diagnostics" src="_images/diagnostics1.png" /></p>
<p>Play about in the development instance, and the editor will respond as a line moves between being valid and invalid.  Now, if you’ve had your porridge/coffee/whatever, and are feeling super alert, you might be wondering why.  So far, we’ve only looked at the <code class="docutils literal notranslate"><span class="pre">textDocument/didOpen</span></code> message.  That only gets sent when a file is opened.  So how is the editor responding as we edit the file?  The answer is the skeleton already implements another notification, <code class="docutils literal notranslate"><span class="pre">textDocument/didChange</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="nd">@greet_server</span><span class="o">.</span><span class="n">feature</span><span class="p">(</span><span class="n">TEXT_DOCUMENT_DID_CHANGE</span><span class="p">)</span>
<span class="linenos">2</span><span class="k">def</span> <span class="nf">did_change</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">DidChangeTextDocumentParams</span><span class="p">):</span>
<span class="linenos">3</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Text document did change notification.&quot;&quot;&quot;</span>
<span class="linenos">4</span>    <span class="n">_parse</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
<p>Compare it to the <code class="docutils literal notranslate"><span class="pre">textDocument/didOpen</span></code> function <a class="reference internal" href="#did-open">above</a> and you’ll see the implementation is exactly the same: call the <code class="docutils literal notranslate"><span class="pre">_parse()</span></code> function.  So parsing gets invoked both when a file is opened, and when it’s changed.</p>
<p>That’s it for our first language feature implementation - job done.  It’s notable that the code for actually checking the file has taken a lot less column inches than all of the preparation that preceded it.  Of course, <code class="docutils literal notranslate"><span class="pre">greet</span></code> is a trivial language.  And, so far, we’ve only implemented basic diagnostics.</p>
<p>The code at this point is tagged as <a class="reference external" href="https://github.com/sfinnie/helloLSP/releases/tag/v0.2">v0.2</a>.</p>
<p>Before we add any additional capabilities, we should think about testing.</p>
<hr class="footnotes docutils" />
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id4" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">4</a><span class="fn-bracket">]</span></span>
<p>It’s not strictly necessary to include the <code class="docutils literal notranslate"><span class="pre">activationEvents</span></code> section: vscode infers that from language contributions in recent versions.  There’s no downsides to doing so though, and means the extension will work with older versions of vscode.</p>
</aside>
<aside class="footnote brackets" id="id5" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">5</a><span class="fn-bracket">]</span></span>
<p>Just in case you’re in any doubt, change the message to something like ‘Text Document Did Open a greet file’ and launch a development instance.  Open a <code class="docutils literal notranslate"><span class="pre">.greet</span></code> file, and marvel at the outcome.</p>
</aside>
<aside class="footnote brackets" id="id6" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">6</a><span class="fn-bracket">]</span></span>
<p>the underscore is a convention to indicate that <code class="docutils literal notranslate"><span class="pre">validate()</span></code> is a function only intended for use inside <code class="docutils literal notranslate"><span class="pre">server.py</span></code>.</p>
</aside>
</aside>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">HelloLSP</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">First Language Server</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#implementation-skeleton">Implementation Skeleton</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pre-requisites">Pre-Requisites</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#anatomy-of-the-plugin">Anatomy of the Plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tidying-up-the-skeleton">Tidying up the skeleton</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#tiny-baby-steps-setting-the-language">Tiny baby steps - setting the language</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cleaning-up">Cleaning up</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#naming-enough-already-json">Naming: enough, already, Json</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#package-json">Package.json</a></li>
<li class="toctree-l3"><a class="reference internal" href="#extension-ts">extension.ts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#server-py">server.py</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#implementing-greet-language-support">Implementing Greet Language Support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing the Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="definition-reference.html">Definitions and References</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="intro.html" title="previous chapter">Introduction</a></li>
      <li>Next: <a href="testing.html" title="next chapter">Testing</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, sfinnie.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 6.1.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="_sources/first_server.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>